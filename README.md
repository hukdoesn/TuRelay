# 命令告警功能需求

## 功能概述
当用户通过我的应用程序进行 SSH 连接并执行命令时，系统需要检查是否存在与当前正在连接的 SSH 主机关联的命令告警或拦截规则。根据检查结果，系统可以采取相应的处理措施，包括发送告警通知和阻止命令执行。

---

## 命令告警规则检查

### 无关联告警规则
- 用户可以正常操作，系统无需对命令进行检查或处理。

### 存在关联告警规则
- 系统检查用户输入的命令，判断是否与预定义的告警规则匹配。

#### 如果命令匹配告警规则：
- 系统根据选择的告警联系人发送告警通知（如：钉钉、企业微信、飞书等）。
- 系统可以选择阻止命令执行（命令拦截功能）。

#### 如果命令不匹配告警规则：
- 允许命令正常执行，不进行额外处理。

---

## 命令拦截功能

### 无关联拦截规则
- 用户的命令正常执行，系统不进行拦截。

### 存在关联拦截规则
- 系统对用户输入的命令进行检查。

#### 如果命令匹配拦截规则：
- 系统阻止命令执行，不将命令发送至 SSH 服务器。
- 向用户发送提示信息，告知该命令已被阻止。
- 同时，系统根据告警联系人发送告警通知。

#### 如果命令不匹配拦截规则：
- 允许命令正常执行。

---

## 核心实现逻辑

### 主机关联性检查
- 在任何命令检查之前，系统首先确认当前连接的主机是否在 `CommandAlert` 表中存在关联的告警或拦截规则。
- 只有当主机存在关联规则时，才会对用户输入的命令进行匹配和检查。

### 命令匹配和处理
- 对于关联的主机，系统需要在命令发送到 SSH 服务器之前，对用户的完整命令进行匹配检查。
- 根据匹配结果，决定是否发送告警通知以及是否阻止命令的执行。

---

## 告警通知
- 当命令匹配告警或拦截规则时，系统向关联的告警联系人发送通知。
- 通知内容应包括以下详细信息：
  - 用户名
  - 输入的命令
  - 主机信息
  - 时间戳

## 建议
### 性能和效率
- 问题：
  - 在每次用户输入命令时，都需要查询数据库，检查是否存在关联的告警或拦截规则。如果用户数量较多，或系统并发量较大，可能会导致性能问题。
- 建议：
  - 预加载规则： 在用户建立 SSH 连接时，预先加载与当前主机关联的告警和拦截规则，存储在会话中，供本次会话期间使用，减少数据库查询次数。
  - 缓存机制： 使用缓存Redis来存储告警规则，定期更新，进一步提高查询效率。
### 规则匹配的准确性和灵活性
- 问题：
  - 命令匹配可能涉及复杂的正则表达式或字符串匹配，需要确保匹配逻辑的准确性，避免误判或漏判。
- 建议：
  - 多种匹配方式： 支持多种匹配方式，精确匹配、模糊匹配，满足不同的需求。那么models.py数据库和前端组件CommandAlert.vue和command_alert.py都需要修改一下这个